---
- hosts: kube
  become: true

  vars_files:
    - vars/main.yml

  pre_tasks:
    # See: https://www.jeffgeerling.com/k8s-cni-virtualbox
    - include_tasks: tasks/flannel-setup.yml
      when: inventory_hostname == 'kube1'

    # See: https://github.com/kubernetes/kubernetes/issues/71305
    - name: Use iptables-legacy instead of nftables.
      alternatives:
        name: '{{ item.name }}'
        path: '{{ item.path }}'
      with_items:
        - { name: iptables, path: /usr/sbin/iptables-legacy }
        - { name: ip6tables, path: /usr/sbin/ip6tables-legacy }

  roles:
    - role: geerlingguy.security
      tags: ['security']

    - role: geerlingguy.swap
      tags: ['swap']

    - role: geerlingguy.docker
      tags: ['docker']

    - role: geerlingguy.kubernetes
      tags: ['kubernetes']
